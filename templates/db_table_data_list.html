{% extends 'base.html' %}
{% load ui_extras %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <div class="sapy-table-container">
    <div class="sapy-table-header">
      <h4 class="sapy-btn-icon">
        <i class="bi bi-table"></i>
        {{ title }}
      </h4>
      <div class="sapy-table-actions">
        <a class="btn btn-light sapy-btn-icon" href="{% url 'sapy:db_table_detail' table.pk %}">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="sapy-table table table-striped align-middle" id="dataTable">
        <thead>
          <tr>
            {% for c in columns %}
              <th>{{ c.label }}</th>
            {% endfor %}
            {% if has_activo %}<th class="sapy-col-actions">Acciones</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr data-row-id="{{ row.id }}" class="{% if row.activo %}sapy-row-active{% else %}sapy-row-inactive{% endif %}">
            {% for c in columns %}
              {% if c.is_toggle %}
                <td class="sapy-col-status">
                  <span class="sapy-badge {% if row.activo %}sapy-badge-status-active{% else %}sapy-badge-status-inactive{% endif %}">
                    {{ row.activo|yesno:'Activo,Inactivo' }}
                  </span>
                </td>
              {% else %}
                <td>{{ row|get_item:c.name }}</td>
              {% endif %}
            {% endfor %}
            {% if has_activo %}
            <td class="sapy-col-actions">
              <button type="button" class="sapy-toggle-btn {% if row.activo %}active{% else %}inactive{% endif %} btn-toggle" title="Alternar estado">
                Alternar
              </button>
            </td>
            {% endif %}
          </tr>
          {% empty %}
          <tr>
            <td colspan="99" class="sapy-empty-state">
              <div class="sapy-empty-state-icon">
                <i class="bi bi-database"></i>
              </div>
              <div class="sapy-empty-state-title">Sin datos</div>
              <div class="sapy-empty-state-text">No hay registros en esta tabla</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('click', function(e){
  const btn = e.target.closest('.btn-toggle');
  if (!btn) return;
  const row = btn.closest('tr');
  const rowId = row && row.getAttribute('data-row-id');
  if (!rowId) return;
  btn.disabled = true;
  fetch(`{% url 'sapy:db_table_toggle_activo' table.pk 0 %}`.replace('/0/', `/${rowId}/`), {
    method: 'POST',
    headers: { 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' }
  }).then(r => r.json()).then(j => {
    if (j && j.success){
      const badge = row.querySelector('span.badge');
      if (badge){
        badge.textContent = j.activo ? 'Activo' : 'Inactivo';
        badge.className = 'badge ' + (j.activo ? 'bg-success' : 'bg-secondary');
      }
    } else {
      alert('No se pudo alternar: ' + (j && j.message ? j.message : 'Error'));
    }
  }).catch(() => alert('Error de red')).finally(() => btn.disabled = false);
});
</script>
{% endblock %}
{% endblock %}

