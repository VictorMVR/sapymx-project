{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{{ title }}</h2>
    <div class="btn-group">
      <a href="{% url 'sapy:application_detail' application.pk %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver a Aplicación
      </a>
      <a href="{% url 'sapy:menus_list' %}" class="btn btn-outline-info">
        <i class="bi bi-list"></i> Ver Menús
      </a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-generate-pages">
        <i class="bi bi-magic"></i> Generar páginas
      </button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header"><strong>Menús asignados</strong></div>
        <div class="card-body">
          {% if assigned_menus %}
          <div class="accordion" id="menusAccordion">
            {% for item in assigned_menus %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="h-{{ item.menu.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c-{{ item.menu.id }}">
                  {% if item.menu.icon %}<i class="{{ item.menu.icon }} me-2"></i>{% endif %} {{ item.menu.title }}
                </button>
              </h2>
              <div id="c-{{ item.menu.id }}" class="accordion-collapse collapse" data-bs-parent="#menusAccordion">
                <div class="accordion-body">
                  {% if item.pages %}
                  <div class="table-responsive">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>Página</th>
                          <th>Ruta</th>
                          <th>Sección</th>
                          <th>Orden</th>
                          <th>Existe Ruta</th>
                          <th>Registros</th>
                          <th class="text-end">Acción</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for p in item.pages %}
                        <tr>
                          <td>{% if p.icon %}<i class="{{ p.icon }} me-1"></i>{% endif %} {{ p.title }}</td>
                          <td><code>{{ p.route_path }}</code></td>
                          <td>{{ p.section }}</td>
                          <td>{{ p.order_index }}</td>
                          <td>{% if p.route_exists is None %}<span class="text-muted">N/D</span>{% elif p.route_exists %}<span class="text-success">Sí</span>{% else %}<span class="text-danger">No</span>{% endif %}</td>
                          <td>{% if p.records == 'N/D' %}<span class="text-muted">N/D</span>{% else %}{{ p.records }}{% endif %}</td>
                          <td class="text-end">
                            {% if p.source_type == 'dbtable' and p.table_name %}
                              <button type="button" class="btn btn-sm btn-outline-primary" onclick="generateForTable('{{ application.name }}','{{ p.table_name }}', this)"><i class="bi bi-magic"></i> Crear página</button>
                            {% else %}
                              <span class="text-muted">—</span>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <div class="text-muted">Este menú no tiene páginas asignadas</div>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-muted">Sin menús asignados</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header"><strong>Asignar menú</strong></div>
        <div class="card-body">
          <form method="get" class="mb-3" onsubmit="return false;">
            <div class="input-group">
              <input id="menuSearch" type="text" class="form-control" placeholder="Buscar menú..." value="{{ search_query }}">
              <button class="btn btn-outline-secondary" type="button" onclick="triggerMenuSearch()"><i class="bi bi-search"></i></button>
            </div>
          </form>
          <div id="menuResults"></div>
          <div id="menuEmpty" class="text-center py-3 d-none text-muted">Sin resultados</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function debounce(fn, d){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); } }
function showSwal(icon, title, html){
  try{
    if (window.Swal) { 
      const options = {icon, title, html, width: 750};
      // Para mensajes de éxito, quitar el timer para que no desaparezcan automáticamente
      if (icon === 'success') {
        options.timer = undefined;
        options.timerProgressBar = false;
        options.showConfirmButton = true;
      }
      Swal.fire(options); 
      return; 
    }
  }catch(e){}
  // Fallback
  alert(title + (html ? ('\n' + (typeof html === 'string' ? html : '')) : ''));
}
async function doMenuSearch(){
  const q = (document.getElementById('menuSearch')?.value || '').trim();
  const resultsEl = document.getElementById('menuResults');
  const emptyEl = document.getElementById('menuEmpty');
  if (!q){ resultsEl.innerHTML=''; emptyEl?.classList.add('d-none'); return; }
  try{
    const resp = await fetch('{% url "sapy:application_menus_search" application.pk %}?q=' + encodeURIComponent(q), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
    const data = await resp.json();
    const rows = (data.results || []).map(item => `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <div class="fw-semibold">${item.icon ? `<i class="${item.icon} me-1"></i>` : ''}${escapeHtml(item.title)}</div>
          <div class="text-muted small"><code>${escapeHtml(item.name)}</code></div>
        </div>
        <form method="post" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="action" value="assign" />
          <input type="hidden" name="menu_id" value="${item.id}" />
          <button class="btn btn-sm btn-outline-success"><i class="bi bi-plus-circle"></i> Asignar</button>
        </form>
      </div>
    `).join('');
    if (rows){ resultsEl.innerHTML = `<div class="list-group list-group-flush">${rows}</div>`; emptyEl?.classList.add('d-none'); }
    else { resultsEl.innerHTML=''; emptyEl?.classList.remove('d-none'); }
  }catch(e){ console.error(e); }
}
const triggerMenuSearch = ()=>doMenuSearch();
document.getElementById('menuSearch')?.addEventListener('input', debounce(doMenuSearch, 250));
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

async function submitGeneratePages(ev){
  ev?.preventDefault();
  const form = document.getElementById('genPagesForm');
  const fd = new FormData(form);
  const btn = document.getElementById('genSubmit');
  const spin = document.getElementById('genSpinner');
  btn?.setAttribute('disabled','disabled'); spin?.classList.remove('d-none');
  try{
    const resp = await fetch('{% url "sapy:application_generate_pages" application.pk %}', {
      method:'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: fd
    });
    const data = await resp.json();
    const out = document.getElementById('genLog');
    const txt = (data.log || data.message || '').slice(-4000);
    out.textContent = txt;
    if (data.success){
      showSwal('success','Generación completada', `<pre style="text-align:left;white-space:pre-wrap">${txt}</pre>`, true);
      // No recargar inmediatamente, esperar confirmación del usuario
    } else {
      showSwal('error','Error al generar páginas', `<pre style="text-align:left;white-space:pre-wrap">${txt}</pre>`);
    }
    if (data.success){
      // No recargar inmediatamente, esperar confirmación del usuario
      // El usuario puede recargar manualmente después de ver el mensaje
    }
  }catch(e){
    showSwal('error','Error de red','');
  } finally {
    btn?.removeAttribute('disabled'); spin?.classList.add('d-none');
  }
}

async function doTableSearch(){
  const q = (document.getElementById('tableSearch')?.value || '').trim();
  const resultsEl = document.getElementById('tableResults');
  const emptyEl = document.getElementById('tableEmpty');
  if (!q){ resultsEl.innerHTML=''; emptyEl?.classList.add('d-none'); return; }
  try{
    const resp = await fetch('{% url "sapy:application_tables_search" application.pk %}?q=' + encodeURIComponent(q), { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
    const data = await resp.json();
    const rows = (data.results || []).map(item => `
      <button type="button" class="list-group-item list-group-item-action" onclick="addTableToken('${item.name}')">
        <div class="fw-semibold">${escapeHtml(item.name)}</div>
        <div class="small text-muted">${escapeHtml(item.description || '')}</div>
      </button>
    `).join('');
    if (rows){ resultsEl.innerHTML = rows; emptyEl?.classList.add('d-none'); }
    else { resultsEl.innerHTML=''; emptyEl?.classList.remove('d-none'); }
  }catch(e){ console.error(e); }
}
document.getElementById('tableSearch')?.addEventListener('input', debounce(doTableSearch, 250));

function addTableToken(name){
  name = (name || '').trim(); if (!name) return;
  const sel = document.getElementById('tableSelected');
  const hidden = document.getElementById('tablesHidden');
  const current = new Set((hidden.value || '').split(',').map(s=>s.trim()).filter(Boolean));
  if (current.has(name)) return;
  current.add(name);
  hidden.value = Array.from(current).join(',');
  const token = document.createElement('span');
  token.className = 'badge text-bg-primary';
  token.innerHTML = `${escapeHtml(name)} <button type="button" class="btn btn-sm btn-light ms-1" onclick="removeTableToken('${name}', this)">x</button>`;
  sel.appendChild(token);
}
function removeTableToken(name, btn){
  const hidden = document.getElementById('tablesHidden');
  const current = new Set((hidden.value || '').split(',').map(s=>s.trim()).filter(Boolean));
  current.delete(name);
  hidden.value = Array.from(current).join(',');
  const token = btn?.closest('span'); if (token) token.remove();
}

async function generateForTable(appName, tableName, formEl){
  try{
    const fd = new FormData();
    fd.append('tables', tableName);
    fd.append('overwrite', 'true');
    const resp = await fetch('{% url "sapy:application_generate_pages" application.pk %}', {
      method:'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: fd
    });
    const data = await resp.json();
    const txt = (data.log || data.message || '').slice(-4000);
    if (data.success){ 
      showSwal('success','Generación completada', `<pre style="text-align:left;white-space:pre-wrap">${txt}</pre>`, true); 
      // No recargar inmediatamente, esperar confirmación del usuario
    }
    else { showSwal('error','Error al generar páginas', `<pre style="text-align:left;white-space:pre-wrap">${txt}</pre>`); }
  }catch(e){ showSwal('error','Error de red',''); }
  return false;
}
</script>

<!-- Modal: Generar páginas -->
<div class="modal fade" id="modal-generate-pages" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generar páginas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="genAlert" class="alert d-none" role="alert"></div>
        <form id="genPagesForm" onsubmit="submitGeneratePages(event)">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Tablas</label>
            <div class="mb-2">
              <input id="tableSearch" type="text" class="form-control" placeholder="Buscar tablas asignadas...">
            </div>
            <div id="tableResults" class="list-group mb-2"></div>
            <div id="tableEmpty" class="text-center py-2 d-none text-muted">Sin resultados</div>
            <div class="form-text mb-2">Selecciona de la lista para agregarlas. O deja vacío y marca “Todas las asignadas”.</div>
            <div id="tableSelected" class="d-flex flex-wrap gap-2"></div>
            <input id="tablesHidden" name="tables" type="hidden" value="">
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="allAssigned" name="all_assigned" value="true">
            <label class="form-check-label" for="allAssigned">Todas las tablas asignadas</label>
          </div>
          <div class="mb-3">
            <label class="form-label">Título del botón del modal</label>
            <input name="btn_title" type="text" class="form-control" placeholder="Agregar registro">
            <div class="form-text">Si se deja vacío, no se muestra el botón del modal en la página.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Slug de menú (opcional)</label>
            <input name="menu" type="text" class="form-control" placeholder="principal">
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="overwrite" name="overwrite" value="true" checked>
            <label class="form-check-label" for="overwrite">Sobrescribir bloques sapy-auto existentes</label>
          </div>
          <div class="d-flex justify-content-end align-items-center gap-2">
            <div id="genSpinner" class="spinner-border spinner-border-sm text-primary d-none" role="status"></div>
            <button id="genSubmit" type="submit" class="btn btn-primary">Generar</button>
          </div>
        </form>
        <hr>
        <pre id="genLog" class="bg-light p-2 small" style="max-height: 220px; overflow:auto"></pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}


