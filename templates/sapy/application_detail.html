<!-- templates/sapy/application_detail.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Información Principal -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-app me-2"></i>
                        {{ application.display_name }}
                    </h5>
                    <div>
                        {% if application.status == 'deployed' %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Desplegada
                            </span>
                        {% elif application.status == 'installing' %}
                            <span class="badge bg-warning">
                                <i class="bi bi-hourglass-split"></i> Instalando...
                            </span>
                        {% elif application.status == 'error' %}
                            <span class="badge bg-danger">
                                <i class="bi bi-exclamation-triangle"></i> Error
                            </span>
                        {% else %}
                            <span class="badge bg-info">{{ application.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Información Básica</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">Nombre Técnico:</td>
                                    <td>{{ application.name }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Dominio:</td>
                                    <td>
                                        <a href="https://{{ application.domain }}/" target="_blank">
                                            https://{{ application.domain }}
                                            <i class="bi bi-box-arrow-up-right small"></i>
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Ruta:</td>
                                    <td><code>{{ application.get_full_path }}</code></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Creada:</td>
                                    <td>{{ application.created_at|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% if application.installed_at %}
                                <tr>
                                    <td class="fw-bold">Instalada:</td>
                                    <td>{{ application.installed_at|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-muted">Base de Datos</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">Motor:</td>
                                    <td><span class="badge bg-secondary">{{ application.db_engine }}</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Nombre BD:</td>
                                    <td>{{ application.db_name }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Host:</td>
                                    <td>{{ application.db_host }}:{{ application.db_port }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Usuario:</td>
                                    <td>{{ application.db_user }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if application.description %}
                    <div class="mt-3">
                        <h6 class="text-muted">Descripción</h6>
                        <p>{{ application.description }}</p>
                    </div>
                    {% endif %}

                    {% if active_log %}
                    <hr>
                    <h6 class="text-muted">Log en vivo</h6>
                    <pre id="liveLog" class="bg-black text-light p-3 rounded" style="height: 300px; overflow: auto; white-space: pre-wrap;">Cargando...</pre>
                    {% endif %}
                </div>
                <div class="card-footer bg-light">
                    <div class="btn-group" role="group">
                        <a href="{% url 'sapy:application_edit' application.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil me-1"></i> Editar
                        </a>
                        {% if application.status == 'deployed' %}
                        <a href="https://{{ application.domain }}/admin/" target="_blank" class="btn btn-outline-success">
                            <i class="bi bi-speedometer2 me-1"></i> Admin Django
                        </a>
                        {% endif %}
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash me-1"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Dependencias -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-box-seam me-2"></i>
                        Dependencias Python
                    </h6>
                </div>
                <div class="card-body">
                    {% if application.dependencies.all %}
                    <div class="row">
                        {% for dep in application.dependencies.all %}
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-secondary">
                                {{ dep.package_name }}{% if dep.version %}=={{ dep.version }}{% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No hay dependencias configuradas</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Logs de Deployment -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Historial de Instalaciones
                    </h6>
                </div>
                <div class="card-body">
                    {% if recent_logs %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Estado</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in recent_logs %}
                                <tr>
                                    <td>{{ log.started_at|date:"d/m/Y H:i" }}</td>
                                    <td>{{ log.get_log_type_display }}</td>
                                    <td>
                                        {% if log.success %}
                                            <span class="badge bg-success">Exitoso</span>
                                        {% else %}
                                            <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ log.executed_by.username|default:"-" }}</td>
                                    <td>
                                        <a href="{% url 'sapy:deployment_log_detail' application.pk log.pk %}" 
                                           class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-eye"></i> Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay registros de instalación</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Panel de Instalación -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-rocket-takeoff me-2"></i>
                        Instalación Rápida
                    </h6>
                </div>
                <div class="card-body">
                    {% if application.status == 'draft' or application.status == 'error' %}
                    <form method="post" action="{% url 'sapy:application_deploy' application.pk %}" id="deployForm">
                        {% csrf_token %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-1"></i>
                            Este proceso creará la aplicación en el servidor usando la configuración mínima necesaria.
                        </div>
                        <button type="submit" class="btn btn-success w-100" id="deployBtn">
                            <i class="bi bi-play-circle me-1"></i>
                            Instalar Aplicación
                        </button>
                    </form>
                    {% elif application.status == 'installing' %}
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Instalando...</span>
                        </div>
                        <p>Instalación en progreso...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted d-block mt-2">Este proceso puede tomar varios minutos</small>
                    </div>
                    {% elif application.status == 'deployed' %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-1"></i>
                        Aplicación instalada exitosamente
                    </div>
                    <div class="d-grid gap-2">
                        <a href="https://{{ application.domain }}/" target="_blank" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right me-1"></i>
                            Abrir Aplicación
                        </a>
                        <a href="https://{{ application.domain }}/admin/" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-speedometer2 me-1"></i>
                            Panel Admin
                        </a>
                        <form method="post" action="{% url 'sapy:application_deploy' application.pk %}"
                              onsubmit="return confirm('¿Reinstalar la aplicación? Esto es idempotente y sobrescribirá configuración de Nginx y recargará servicios.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Reinstalar
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Variables de Entorno -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Variables de Entorno
                    </h6>
                </div>
                <div class="card-body">
                    {% if application.environment_vars.all %}
                    <ul class="list-unstyled mb-0">
                        {% for var in application.environment_vars.all %}
                        <li class="mb-1">
                            <code>{{ var.key }}={% if var.is_secret %}***{% else %}{{ var.value }}{% endif %}</code>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">No hay variables configuradas</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que quieres eliminar la aplicación <strong>{{ application.display_name }}</strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'sapy:application_delete' application.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="confirm" value="yes">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Confirmación de eliminación
function confirmDelete() {
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Auto-actualizar estado si está instalando
{% if application.status == 'installing' %}
setInterval(function() {
    fetch("{% url 'sapy:application_status' application.pk %}")
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'installing') {
                location.reload();
            }
        });
}, 5000);
{% endif %}

{% if active_log %}
// Poll del log en vivo
const liveLogEl = document.getElementById('liveLog');
const streamUrl = "{% url 'sapy:deployment_log_stream' application.pk active_log.pk %}";
function pollLog() {
  fetch(streamUrl)
    .then(r => r.json())
    .then(j => {
      if (liveLogEl) {
        liveLogEl.textContent = (j.output || '') + (j.error_output ? "\n[stderr]\n" + j.error_output : '');
        liveLogEl.scrollTop = liveLogEl.scrollHeight;
      }
      if (!j.completed_at) {
        setTimeout(pollLog, 2000);
      }
    })
    .catch(() => setTimeout(pollLog, 4000));
}
pollLog();
{% endif %}

// Estado del botón de deploy
const deployForm = document.getElementById('deployForm');
if (deployForm) {
  deployForm.addEventListener('submit', function() {
      const btn = document.getElementById('deployBtn');
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Instalando...'; }
  });
}
</script>
{% endblock %}