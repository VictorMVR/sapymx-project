{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="container-fluid mt-3">
  <!-- Encabezado de página estandarizado -->
  <div class="sapy-table-container">
    <div class="sapy-table-header">
      <h4 class="sapy-btn-icon">
        <i class="bi bi-table"></i>
        {{ title }}
      </h4>
      <div class="sapy-table-actions">
        <a class="btn btn-light sapy-btn-icon" href="{% url 'sapy:db_table_create' %}">
          <i class="bi bi-plus-square"></i> Nueva Tabla BD
        </a>
      </div>
    </div>

    <!-- Vista móvil: tarjetas estandarizadas -->
    <div class="sapy-mobile-view">
      {% for t in tables %}
      <div class="sapy-mobile-card">
        <div class="sapy-mobile-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="sapy-mobile-card-title">{{ t.alias }}</div>
              <div class="sapy-mobile-card-subtitle">
                <span class="sapy-text-code">{{ t.schema_name|default:'public' }}.{{ t.name }}</span>
              </div>
            </div>
            <span class="fw-medium text-primary">{{ t.get_table_kind_display }}</span>
          </div>
        </div>
        <div class="sapy-mobile-card-body">
          <div class="d-flex justify-content-between align-items-center">
            <span class="sapy-text-muted">Columnas:</span>
            <span class="fw-semibold">{{ t.columns.count }}</span>
          </div>
        </div>
        <div class="sapy-mobile-card-actions">
          <a class="btn btn-sm btn-outline-secondary flex-fill sapy-btn-icon" href="{% url 'sapy:db_table_edit' t.pk %}">
            <i class="bi bi-pencil-square"></i> Editar
          </a>
          <button type="button" class="btn btn-sm btn-success flex-fill sapy-btn-icon btn-gen-page" data-table-id="{{ t.pk }}">
            <i class="bi bi-magic"></i> Generar
          </button>
          <form method="post" action="{% url 'sapy:db_table_delete' t.pk %}" class="flex-fill" onsubmit="return confirm('¿Eliminar tabla {{ t.name }}?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger w-100 sapy-btn-icon">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </div>
      </div>
      {% empty %}
      <div class="sapy-empty-state">
        <div class="sapy-empty-state-icon">
          <i class="bi bi-table"></i>
        </div>
        <div class="sapy-empty-state-title">No hay tablas registradas</div>
        <div class="sapy-empty-state-text">Comienza creando tu primera tabla de base de datos</div>
        <a class="btn btn-primary sapy-btn-icon" href="{% url 'sapy:db_table_create' %}">
          <i class="bi bi-plus-square"></i> Nueva Tabla BD
        </a>
      </div>
      {% endfor %}
    </div>

    <!-- Vista desktop: tabla estandarizada -->
    <div class="sapy-desktop-view">
      <div class="table-responsive">
        <table class="sapy-table table table-striped align-middle">
          <thead>
            <tr>
              <th>Esquema</th>
              <th>Tabla</th>
              <th>Alias</th>
              <th>Tipo</th>
              <th class="sapy-col-numeric">Columnas</th>
              <th class="sapy-col-status">Estado</th>
              <th class="sapy-col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tables %}
            <tr class="{% if t.activo %}sapy-row-active{% else %}sapy-row-inactive{% endif %}">
              <td><span class="sapy-text-code">{{ t.schema_name|default:'public' }}</span></td>
              <td><a href="{% url 'sapy:db_table_detail' t.pk %}" class="sapy-text-code">{{ t.name }}</a></td>
              <td>{{ t.alias }}</td>
              <td><span class="sapy-badge sapy-badge-type">{{ t.get_table_kind_display }}</span></td>
              <td class="sapy-col-numeric">{{ t.columns.count }}</td>
              <td class="sapy-col-status">
                <form method="post" action="{% url 'sapy:db_table_toggle_active' t.pk %}" class="d-inline">
                  {% csrf_token %}
                  <button class="sapy-toggle-btn {% if t.activo %}active{% else %}inactive{% endif %}" title="{% if t.activo %}Activo{% else %}Inactivo{% endif %}">
                    {% if t.activo %}Activo{% else %}Inactivo{% endif %}
                  </button>
                </form>
              </td>
              <td class="sapy-col-actions">
                <div class="sapy-btn-group">
                  <a class="btn btn-sm btn-outline-secondary sapy-btn-icon" href="{% url 'sapy:db_table_edit' t.pk %}" title="Editar tabla">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <button type="button" class="btn btn-sm btn-success sapy-btn-icon btn-gen-page" data-table-id="{{ t.pk }}" title="Generar página">
                    <i class="bi bi-magic"></i>
                  </button>
                  <form method="post" action="{% url 'sapy:db_table_delete' t.pk %}" class="d-inline" onsubmit="return confirm('¿Eliminar tabla {{ t.name }}?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger sapy-btn-icon" title="Eliminar tabla">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="sapy-empty-state">
                <div class="sapy-empty-state-icon">
                  <i class="bi bi-table"></i>
                </div>
                <div class="sapy-empty-state-title">No hay tablas registradas</div>
                <div class="sapy-empty-state-text">Comienza creando tu primera tabla de base de datos</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }
  document.querySelectorAll('.btn-gen-page').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-table-id');
      try{
        if (typeof showLoading === 'function') showLoading('Generando página...');
        const resp = await fetch('{% url "sapy:page_generate_from_dbtable" %}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          body: JSON.stringify({ dbtable_id: parseInt(id) })
        });
        const data = await resp.json();
        if (typeof hideLoading === 'function') hideLoading();
        if (!resp.ok || !data.success){
          if (typeof showError === 'function') showError(data.message || 'No se pudo generar la página');
          return;
        }
        if (typeof showSuccess === 'function') showSuccess('Página generada');
        window.location.href = '{% url "sapy:page_detail" 0 %}'.replace('/0/', '/' + data.page_id + '/');
      }catch(e){
        if (typeof hideLoading === 'function') hideLoading();
        if (typeof showError === 'function') showError(e && e.message ? e.message : 'Error inesperado');
      }
    });
  });
})();
</script>
{% endblock %}

